<!DOCTYPE html>
<html>
	<head>
		<script src="/public/ractive.js"></script>
		<script src='/public/ractive-events-keys.js'></script>
		<meta charset=utf-8 />
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>fintfolk!</title>
		<link href="/public/normalize.css" media="all" rel="stylesheet" type="text/css" />
		<link href="/public/styles.css" media="screen" rel="stylesheet" type="text/css" />
	</head>

	<body>
		<div class="container" id="app">
		</div>
		<script id='template' type='text/ractive'>
			<div class='searchBar'>
				<span><strong>folk.deichman.no</strong></span>
				<input type='search' value='{{q}}'/>
				<select value='{{.selectedDept}}'>
					{{#departments}}
						<option value='{{ID}}'>{{Name}}</option>
					{{/departments}}
				</select>
			</div>
			{{#persons}}
				<div class="person{{# hiddenDept(Dept)}} hidden{{/}}">
					<img src="/public/img/{{Img}}">
					<strong><a href="mailto:{{Email}}">{{Name}}</a></strong><br/>
					<em>{{Role}} / {{deptName(Dept) }}</em><br/>
					☎ {{Phone}}<br/>
					<span class="person-info">{{Info}}<span>
				</div>
			{{/persons}}
		</script>
		<script>
			var ractive = new Ractive({
				el: 'app',
				template: '#template',
				data: {
					"deptName": function( id ) { return ractive.data.deptNames[id]; },
					"hiddenDept": function( id ) {
						s = ractive.get( 'selectedDept' );
						console.log(s);
						return !( s == 0 || id == s || ractive.data.deptParents[id] == s);
					}
				}
			});


			// Fetch departments
			var req = new XMLHttpRequest();
			req.open( 'GET', '/api/department', true );
			req.setRequestHeader( 'Content-Type', 'application/json; charset=UTF-8' );

			req.onerror = function( e ) {
				console.log( "failed to reach server: " + e.target.status );
			}

			req.onload = function( e ) {
				if ( e.target.status != 200 ) {
					console.log( "/api/department responed with status " +
						         e.target.stats + " " + e.target.statusText );
					return;
				}

				var depts = JSON.parse( e.target.responseText);
				var deptNames = {};
				var deptParents = {};
				depts.forEach(function(d) {
					deptNames[d.ID] = d.Name;
					deptParents[d.ID] = d.Parent;
					if ( d.Parent != 0 ) {
						d.Name = '― ' + d.Name;
					}
				});
				depts.unshift( {"Name": "Hele biblioteket", "ID": 0, "Parent": 0} );
				ractive.set( 'departments',  depts );
				ractive.set( 'deptNames', deptNames);
				ractive.set( 'deptParents', deptParents);
			}

			req.send();

			// Fetch all folks
			var req2 = new XMLHttpRequest();
			req2.open( 'GET', '/api/person?order=random', true );
			req2.setRequestHeader( 'Content-Type', 'application/json; charset=UTF-8' );

			req2.onerror = function( e ) {
				console.log( "failed to reach server: " + e.target.status );
			}

			req2.onload = function( e ) {
				if ( e.target.status != 200 ) {
					console.log( "/api/person responed with status " +
						         e.target.stats + " " + e.target.statusText );
					return;
				}

				var persons = JSON.parse( e.target.responseText);
				ractive.set( 'persons',  persons );
			}

			req2.send();

		</script>
	</body>
</html>
